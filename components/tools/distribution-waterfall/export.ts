import { WaterfallOutput, formatCurrency, formatPercent, formatMultiple } from './waterfallCalculations'
import {
  downloadCSV,
  createKeyValueSection,
  createTableSection,
  type CSVSection
} from '@/lib/exports'
import {
  downloadPDF,
  createPDFTableSection,
  type PDFSection
} from '@/lib/exports'

// Text export for detailed summary
export function exportWaterfallSummary(output: WaterfallOutput) {
  const timestamp = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })

  const content = `
DISTRIBUTION WATERFALL ANALYSIS
Generated: ${timestamp}
Source: FundOpsHQ Distribution Waterfall Visualizer

═══════════════════════════════════════════════════════════════════════

KEY INPUTS
═══════════════════════════════════════════════════════════════════════

Fund Size:               ${formatCurrency(output.input.fundSize)}
Contributed Capital:     ${formatCurrency(output.input.contributedCapital)}
Gross Proceeds:          ${formatCurrency(output.input.grossProceeds)}
Years to Exit:           ${output.input.yearsToExit} years

Waterfall Type:          ${output.input.waterfallType === 'european' ? 'European (Whole-Fund)' : 'American (Deal-by-Deal)'}
Preferred Return:        ${formatPercent(output.input.prefRate, 1)} annual (${output.input.prefCompounding})
Carried Interest:        ${formatPercent(output.input.carryRate, 0)}
GP Catch-Up:             ${output.input.hasCatchUp ? `Yes (${formatPercent(output.input.catchUpRate, 0)} to GP)` : 'No'}
GP Commitment:           ${formatPercent(output.input.gpCommitmentPercent, 2)}

═══════════════════════════════════════════════════════════════════════

DISTRIBUTION SUMMARY
═══════════════════════════════════════════════════════════════════════

Total Proceeds:          ${formatCurrency(output.totalDistributed)}

LP Distributions:        ${formatCurrency(output.totalToLPs)}
  LP Multiple (MOIC):    ${formatMultiple(output.lpMultiple)}
  LP Share of Total:     ${formatPercent(output.totalToLPs / output.totalDistributed, 1)}

GP Distributions:        ${formatCurrency(output.totalToGP)}
  GP Multiple (MOIC):    ${formatMultiple(output.gpMultiple)}
  GP Share of Total:     ${formatPercent(output.totalToGP / output.totalDistributed, 1)}

Total Profit:            ${formatCurrency(output.totalProfit)}
  LP Profit:             ${formatCurrency(output.lpProfit)}
  GP Profit:             ${formatCurrency(output.gpProfit)}
  Effective Carry Rate:  ${formatPercent(output.effectiveCarryRate, 2)}

═══════════════════════════════════════════════════════════════════════

TIER-BY-TIER BREAKDOWN
═══════════════════════════════════════════════════════════════════════

${output.tiers.map((tier, index) => `
TIER ${tier.tier}: ${tier.name.toUpperCase()}
${tier.description}

  Amount Distributed:    ${formatCurrency(tier.total)}
  To LPs:                ${formatCurrency(tier.toLPs)}
  To GP:                 ${formatCurrency(tier.toGP)}

  Cumulative to LPs:     ${formatCurrency(tier.cumulativeLPs)}
  Cumulative to GP:      ${formatCurrency(tier.cumulativeGP)}
  Cumulative Total:      ${formatCurrency(tier.cumulativeTotal)}

  % of Total Proceeds:   ${formatPercent(tier.total / output.totalDistributed, 1)}
${index < output.tiers.length - 1 ? '\n───────────────────────────────────────────────────────────────────────' : ''}
`).join('\n')}

═══════════════════════════════════════════════════════════════════════

Generated by FundOpsHQ Distribution Waterfall Visualizer
https://fundopshq.com/tools/distribution-waterfall

This is an educational model only. Actual fund economics depend on specific
LPA terms, timing of capital calls and distributions, fees, expenses, and
other factors. Consult with legal and financial advisors for fund structuring.

═══════════════════════════════════════════════════════════════════════
`.trim()

  // Create and download the file
  const blob = new Blob([content], { type: 'text/plain' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `waterfall-analysis-${new Date().toISOString().split('T')[0]}.txt`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

// CSV export
export function exportWaterfallCSV(output: WaterfallOutput) {
  const sections: CSVSection[] = [
    // Key Inputs
    createKeyValueSection('Key Inputs', {
      'Fund Size': formatCurrency(output.input.fundSize),
      'Contributed Capital': formatCurrency(output.input.contributedCapital),
      'Gross Proceeds': formatCurrency(output.input.grossProceeds),
      'Years to Exit': `${output.input.yearsToExit} years`,
      'Waterfall Type': output.input.waterfallType === 'european' ? 'European (Whole-Fund)' : 'American (Deal-by-Deal)',
      'Preferred Return': `${(output.input.prefRate * 100).toFixed(1)}% (${output.input.prefCompounding})`,
      'Carried Interest': `${(output.input.carryRate * 100).toFixed(0)}%`,
      'GP Catch-Up': output.input.hasCatchUp ? `Yes (${(output.input.catchUpRate * 100).toFixed(0)}% to GP)` : 'No',
      'GP Commitment': `${(output.input.gpCommitmentPercent * 100).toFixed(2)}%`
    }),

    // Distribution Summary
    createKeyValueSection('Distribution Summary', {
      'Total Proceeds': formatCurrency(output.totalDistributed),
      'LP Distributions': formatCurrency(output.totalToLPs),
      'LP Multiple (MOIC)': formatMultiple(output.lpMultiple),
      'LP Share of Total': `${((output.totalToLPs / output.totalDistributed) * 100).toFixed(1)}%`,
      'GP Distributions': formatCurrency(output.totalToGP),
      'GP Multiple (MOIC)': formatMultiple(output.gpMultiple),
      'GP Share of Total': `${((output.totalToGP / output.totalDistributed) * 100).toFixed(1)}%`,
      'Total Profit': formatCurrency(output.totalProfit),
      'Effective Carry Rate': `${(output.effectiveCarryRate * 100).toFixed(2)}%`
    }),

    // Tier Breakdown
    createTableSection(
      'Tier-by-Tier Breakdown',
      ['Tier', 'Name', 'Amount', 'To LPs', 'To GP', '% of Total'],
      output.tiers.map(tier => [
        String(tier.tier),
        tier.name,
        formatCurrency(tier.total),
        formatCurrency(tier.toLPs),
        formatCurrency(tier.toGP),
        `${((tier.total / output.totalDistributed) * 100).toFixed(1)}%`
      ])
    )
  ]

  downloadCSV({
    filename: `waterfall-analysis-${new Date().toISOString().split('T')[0]}`,
    toolName: 'Distribution Waterfall Visualizer',
    sections,
    includeDisclaimer: true
  })
}

// PDF export
export function exportWaterfallPDF(output: WaterfallOutput) {
  const sections: PDFSection[] = [
    // Key Inputs
    { type: 'title', content: 'Key Inputs' },
    {
      type: 'keyValue',
      data: {
        'Fund Size': formatCurrency(output.input.fundSize),
        'Contributed Capital': formatCurrency(output.input.contributedCapital),
        'Gross Proceeds': formatCurrency(output.input.grossProceeds),
        'Years to Exit': `${output.input.yearsToExit} years`
      }
    },
    {
      type: 'keyValue',
      data: {
        'Waterfall Type': output.input.waterfallType === 'european' ? 'European' : 'American',
        'Preferred Return': `${(output.input.prefRate * 100).toFixed(1)}%`,
        'Carried Interest': `${(output.input.carryRate * 100).toFixed(0)}%`,
        'GP Catch-Up': output.input.hasCatchUp ? 'Yes' : 'No'
      }
    },

    { type: 'spacer' },

    // Distribution Summary
    { type: 'title', content: 'Distribution Summary' },
    {
      type: 'keyValue',
      data: {
        'Total Proceeds': formatCurrency(output.totalDistributed),
        'LP Distributions': formatCurrency(output.totalToLPs),
        'LP Multiple': formatMultiple(output.lpMultiple),
        'GP Distributions': formatCurrency(output.totalToGP),
        'GP Multiple': formatMultiple(output.gpMultiple),
        'Effective Carry': `${(output.effectiveCarryRate * 100).toFixed(2)}%`
      }
    },

    { type: 'spacer' },

    // Tier Breakdown
    ...createPDFTableSection(
      'Tier Breakdown',
      ['Tier', 'Name', 'Amount', 'To LPs', 'To GP'],
      output.tiers.map(tier => [
        String(tier.tier),
        tier.name.substring(0, 15),
        formatCurrency(tier.total),
        formatCurrency(tier.toLPs),
        formatCurrency(tier.toGP)
      ])
    )
  ]

  downloadPDF({
    filename: `waterfall-analysis-${new Date().toISOString().split('T')[0]}`,
    toolName: 'Distribution Waterfall Visualizer',
    description: `Waterfall analysis for ${formatCurrency(output.input.grossProceeds)} in proceeds from a ${formatCurrency(output.input.fundSize)} fund.`,
    sections,
    includeDisclaimer: true
  })
}

// Comparison CSV export
export function exportComparisonCSV(outputA: WaterfallOutput, outputB: WaterfallOutput) {
  const sections: CSVSection[] = [
    // Scenario Comparison Summary
    createTableSection(
      'Scenario Comparison',
      ['Metric', 'Scenario A', 'Scenario B', 'Difference'],
      [
        ['Fund Size', formatCurrency(outputA.input.fundSize), formatCurrency(outputB.input.fundSize), formatCurrency(outputB.input.fundSize - outputA.input.fundSize)],
        ['Gross Proceeds', formatCurrency(outputA.input.grossProceeds), formatCurrency(outputB.input.grossProceeds), formatCurrency(outputB.input.grossProceeds - outputA.input.grossProceeds)],
        ['Waterfall Type', outputA.input.waterfallType === 'european' ? 'European' : 'American', outputB.input.waterfallType === 'european' ? 'European' : 'American', '-'],
        ['Preferred Return', `${(outputA.input.prefRate * 100).toFixed(1)}%`, `${(outputB.input.prefRate * 100).toFixed(1)}%`, `${((outputB.input.prefRate - outputA.input.prefRate) * 100).toFixed(1)}%`],
        ['Carry Rate', `${(outputA.input.carryRate * 100).toFixed(0)}%`, `${(outputB.input.carryRate * 100).toFixed(0)}%`, `${((outputB.input.carryRate - outputA.input.carryRate) * 100).toFixed(0)}%`],
        ['GP Catch-Up', outputA.input.hasCatchUp ? 'Yes' : 'No', outputB.input.hasCatchUp ? 'Yes' : 'No', '-']
      ]
    ),

    // Distribution Results Comparison
    createTableSection(
      'Distribution Results',
      ['Metric', 'Scenario A', 'Scenario B', 'Difference'],
      [
        ['Total Proceeds', formatCurrency(outputA.totalDistributed), formatCurrency(outputB.totalDistributed), formatCurrency(outputB.totalDistributed - outputA.totalDistributed)],
        ['LP Distributions', formatCurrency(outputA.totalToLPs), formatCurrency(outputB.totalToLPs), formatCurrency(outputB.totalToLPs - outputA.totalToLPs)],
        ['GP Distributions', formatCurrency(outputA.totalToGP), formatCurrency(outputB.totalToGP), formatCurrency(outputB.totalToGP - outputA.totalToGP)],
        ['LP Multiple', formatMultiple(outputA.lpMultiple), formatMultiple(outputB.lpMultiple), `${(outputB.lpMultiple - outputA.lpMultiple).toFixed(2)}x`],
        ['GP Multiple', formatMultiple(outputA.gpMultiple), formatMultiple(outputB.gpMultiple), `${(outputB.gpMultiple - outputA.gpMultiple).toFixed(2)}x`],
        ['Effective Carry', `${(outputA.effectiveCarryRate * 100).toFixed(2)}%`, `${(outputB.effectiveCarryRate * 100).toFixed(2)}%`, `${((outputB.effectiveCarryRate - outputA.effectiveCarryRate) * 100).toFixed(2)}%`],
        ['LP Profit', formatCurrency(outputA.lpProfit), formatCurrency(outputB.lpProfit), formatCurrency(outputB.lpProfit - outputA.lpProfit)],
        ['GP Profit', formatCurrency(outputA.gpProfit), formatCurrency(outputB.gpProfit), formatCurrency(outputB.gpProfit - outputA.gpProfit)]
      ]
    ),

    // Scenario A Tier Breakdown
    createTableSection(
      'Scenario A - Tier Breakdown',
      ['Tier', 'Name', 'Amount', 'To LPs', 'To GP'],
      outputA.tiers.map(tier => [
        String(tier.tier),
        tier.name,
        formatCurrency(tier.total),
        formatCurrency(tier.toLPs),
        formatCurrency(tier.toGP)
      ])
    ),

    // Scenario B Tier Breakdown
    createTableSection(
      'Scenario B - Tier Breakdown',
      ['Tier', 'Name', 'Amount', 'To LPs', 'To GP'],
      outputB.tiers.map(tier => [
        String(tier.tier),
        tier.name,
        formatCurrency(tier.total),
        formatCurrency(tier.toLPs),
        formatCurrency(tier.toGP)
      ])
    )
  ]

  downloadCSV({
    filename: `waterfall-comparison-${new Date().toISOString().split('T')[0]}`,
    toolName: 'Distribution Waterfall Visualizer',
    sections,
    includeDisclaimer: true
  })
}

// Comparison PDF export
export function exportComparisonPDF(outputA: WaterfallOutput, outputB: WaterfallOutput) {
  const sections: PDFSection[] = [
    // Comparison Summary Header
    { type: 'title', content: 'Scenario Comparison' },
    ...createPDFTableSection(
      '',
      ['Metric', 'Scenario A', 'Scenario B'],
      [
        ['Fund Size', formatCurrency(outputA.input.fundSize), formatCurrency(outputB.input.fundSize)],
        ['Proceeds', formatCurrency(outputA.input.grossProceeds), formatCurrency(outputB.input.grossProceeds)],
        ['Structure', outputA.input.waterfallType === 'european' ? 'European' : 'American', outputB.input.waterfallType === 'european' ? 'European' : 'American'],
        ['Pref Rate', `${(outputA.input.prefRate * 100).toFixed(1)}%`, `${(outputB.input.prefRate * 100).toFixed(1)}%`],
        ['Carry', `${(outputA.input.carryRate * 100).toFixed(0)}%`, `${(outputB.input.carryRate * 100).toFixed(0)}%`]
      ]
    ),

    { type: 'spacer' },

    // Results Comparison
    { type: 'title', content: 'Distribution Results' },
    ...createPDFTableSection(
      '',
      ['Metric', 'Scenario A', 'Scenario B'],
      [
        ['LP Distributions', formatCurrency(outputA.totalToLPs), formatCurrency(outputB.totalToLPs)],
        ['GP Distributions', formatCurrency(outputA.totalToGP), formatCurrency(outputB.totalToGP)],
        ['LP Multiple', formatMultiple(outputA.lpMultiple), formatMultiple(outputB.lpMultiple)],
        ['GP Multiple', formatMultiple(outputA.gpMultiple), formatMultiple(outputB.gpMultiple)],
        ['Effective Carry', `${(outputA.effectiveCarryRate * 100).toFixed(2)}%`, `${(outputB.effectiveCarryRate * 100).toFixed(2)}%`]
      ]
    ),

    { type: 'spacer' },

    // Impact Analysis
    { type: 'title', content: 'Impact Analysis (B vs A)' },
    {
      type: 'keyValue',
      data: {
        'LP Difference': formatCurrency(outputB.totalToLPs - outputA.totalToLPs),
        'GP Difference': formatCurrency(outputB.totalToGP - outputA.totalToGP),
        'Multiple Change': `${(outputB.lpMultiple - outputA.lpMultiple) >= 0 ? '+' : ''}${(outputB.lpMultiple - outputA.lpMultiple).toFixed(2)}x`,
        'Carry Change': `${((outputB.effectiveCarryRate - outputA.effectiveCarryRate) * 100) >= 0 ? '+' : ''}${((outputB.effectiveCarryRate - outputA.effectiveCarryRate) * 100).toFixed(2)}%`
      }
    }
  ]

  downloadPDF({
    filename: `waterfall-comparison-${new Date().toISOString().split('T')[0]}`,
    toolName: 'Distribution Waterfall Visualizer',
    description: 'Side-by-side comparison of two waterfall scenarios.',
    sections,
    includeDisclaimer: true
  })
}
